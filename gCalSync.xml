<?xml version="1.0"?>
<!--
/************************************************************************
* gCalSync.xml								*
*************************************************************************
* gCalSync 								*
* Copyright 2009-2010 Armen Kaleshian <armen@kriation.com>		*
* License: GNU GPL (v3 or later). See LICENSE.txt for details.		*
*									*
* An enhancement for SMF to synchronize forum calendar entries with a	*
* Google Calendar.							*
* ********************************************************************* *
* This program is free software: you can redistribute it and/or modify	*
* it under the terms of the GNU General Public License as published by	*
* the Free Software Foundation, either version 3 of the License, or	*
* (at your option) any later version.					*
*									*
* This program is distributed in the hope that it will be useful,	*
* but WITHOUT ANY WARRANTY; without even the implied warranty of	*
* MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the		*
* GNU General Public License for more details.				*
*									*
* You should have received a copy of the GNU General Public License	*
* along with this program.  If not, see <http://www.gnu.org/licenses/>.	*
************************************************************************/
-->
<!DOCTYPE modification SYSTEM "http://www.simplemachines.org/xml/modification">
<modification xmlns="http://www.simplemachines.org/xml/modification" xmlns:smf="http://www.simplemachines.org/">
	
	<id>kriation:gCalSync</id>
	<version>1.0.9</version>

	<!-- ************************************* -->
	<!-- gCalSync English Language Additions   -->
	<!-- ************************************* -->
	<file name="$languagedir/Modifications.english.php">
		<operation>
			<search position="end" />
			<add><![CDATA[
// gCalSync Error Messages
$txt['gCalE1'] = 'Could not connect to the Google Calendar service!';
$txt['gCalE2'] = 'Could not establish a Google Calendar object!';
$txt['gCalE3'] = 'Could not use Google Calendar object for insert!';
$txt['gCalE4'] = 'Could not use Google Calendar object for insert!';
$txt['gCalE5'] = 'Result returned more than one row?!?!';
$txt['gCalE6'] = 'Query failed during remove!';
$txt['gCalE7'] = 'gUser and/or gPass have not been set!';

// gCalSync Static Fields
$txt['gCalS1'] = 'gCalSync Settings';
$txt['gCalS2'] = 'Modify gCalSync Settings';
$txt['gCalS3'] = 'Google Calendar Username';
$txt['gCalS4'] = 'Google Calendar Password';
]]></add>
		</operation>
	</file>
	
	<!-- ************************************* -->
	<!-- gCalSync UTF8 Language Additions	   -->
	<!-- ************************************* -->
	<file name="$languagedir/Modifications..english-utf8.php" error="ignore">
		<operation>
			<search position="end" />
			<add><![CDATA[
// gCalSync Error Messages
$txt['gCalE1'] = 'Could not connect to the Google Calendar service!';
$txt['gCalE2'] = 'Could not establish a Google Calendar object!';
$txt['gCalE3'] = 'Could not use Google Calendar object for insert!';
$txt['gCalE4'] = 'Could not use Google Calendar object for insert!';
$txt['gCalE5'] = 'Result returned more than one row?!?!';
$txt['gCalE6'] = 'Query failed during remove!';
$txt['gCalE7'] = 'gUser and/or gPass have not been set!';

// gCalSync Static Fields
$txt['gCalS1'] = 'gCalSync Settings';
$txt['gCalS2'] = 'Modify gCalSync Settings';
$txt['gCalS3'] = 'Google Calendar Username';
$txt['gCalS4'] = 'Google Calendar Password';
]]></add>
		</operation>
	</file>
	
	<!-- ************************************* -->
	<!-- gCalSync Administrative functionality -->
	<!-- ************************************* -->
 	<file name="$sourcedir/ManageCalendar.php">
 		<operation>
			<search position="before"><![CDATA['settings' => 'ModifySettings']]></search>
			<add><![CDATA[,
		'gCalSettings' => 'ModifyGCAL']]></add>
		</operation>

		<operation>
			<search position="before"><![CDATA['tabs' => array(]]>
			</search>
			<add><![CDATA[
			'gCalSettings' => array(
				'title' => $txt['gCalS1'],
				'description' => $txt['gCalS2'],
				'href' => $scripturl . '?action=managecalendar;sa=gCalSettings',
			),]]></add>
		</operation>

		<operation>
			<search position="end" />
			<add><![CDATA[
//Function that handles gCalSync Settings
function ModifyGCAL()
{
	// What global variables do we need here?
	global $context, $sourcedir, $txt;

	loadTemplate('ManageCalendar');
	$context['page_title'] = $txt['gCalS2'];
	$context['sub_template'] = 'modify_gCal';

	// Form has been submitted! Let's process! :-D
	if( isset( $_POST['sc'] ))
	{
		// Always protect yourself!
		checkSession();

		// Easier than I thought...
		updateSettings( array(
			'gCal_user' => $_POST['gCal_user'],
			'gCal_pass' => $_POST['gCal_pass'] ));
		updateStats( 'calendar' );

		// Time to exit!
		redirectexit( 'action=managecalendar;sa=gCalSettings');
	}
}
]]></add>
		</operation>
	</file>

	<file name="$themedir/ManageCalendar.template.php">
		<operation>
			<search position="end" />
			<add><![CDATA[
//gCalSync Settings Template
function template_modify_gCal()
{
	global $context, $scripturl, $sc, $modSettings, $txt;
	echo '
		<!-- Totally borrowed from template_modify_settings() -->
		<form acton=', $scripturl, '?action=managecalendar;sa=gCalSettings" method="post" accept-charset="', $context['character_set'], '"> 
		<table border="0" cellspacing="0" cellpadding="4" align="center" th="80%" class="tborder">
			<tr class="titlebg">
				<td colspan="2">',$txt['gCalS1'],'</td>
			</tr>
			<tr class="windowbg2">
				<td align="right">',$txt['gCalS3'],'</label>:</td>
				<td><input type="text" name="gCal_user" value="', !empty($modSettings['gCal_user']) ? $modSettings['gCal_user'] : '', '" size="40" /></td>
			</tr>
			<tr class="windowbg2">
				<td align="right">',$txt['gCalS4'],'</label>:</td>
				<td><input type="password" name="gCal_pass" value="', !empty($modSettings['gCal_pass']) ? $modSettings['gCal_pass'] : '', '" size="40" /></td>
			</tr>
			<tr class="windowbg2">
				<td align="right" colspan="2">
					<input type="submit" value="', $txt['save_settings'], '" />
				</td>
			</tr>
		</table>
		<input type="hidden" name="sc" value="', $context['session_id'], '" />
		</form>';
}
]]></add>
		</operation>
	</file>
	
	<!-- ************************************* -->
	<!-- gCalSync Runtime functionality -->
	<!-- ************************************* -->

	<!-- For event Insertion -->
	<file name="$sourcedir/Calendar.php">
		<operation>
			<search position="after"><![CDATA[	// Add special chars to the title.]]></search>
			<add><![CDATA[
	global $sourcedir, $boardurl; 

	/* gCalSync: Bringing it in... */
	require_once( $sourcedir . '/gCalSync.php' );
]]></add>
		</operation>
		
		<operation>
			<search position="after"><![CDATA[	// Insert the event!]]></search>
			<add><![CDATA[
	/* Grab a couple of useful values from $modSettings */
	if( !empty($modSettings['gCal_user']) &&
		!empty($modSettings['gCal_pass'] ) )
	{
		$gUser = $modSettings['gCal_user'];
		$gPass = $modSettings['gCal_pass'];
	}
	else
	{
		fatal_lang_error('gCalE7');
	}
]]></add>
		</operation>

		<operation>
<search position="before"><![CDATA[		VALUES ($id_board, $id_topic, SUBSTRING('$title', 1, 48), $id_member, '" . strftime('%Y-%m-%d', mktime(0, 0, 0, $month, $day, $year)) . "', '" . strftime('%Y-%m-%d', mktime(0, 0, 0, $month, $day, $year) + $span * 86400) . "')", __FILE__, __LINE__);]]></search>
			<add><![CDATA[
	/* Initializing the gCalSync for Google Calendar Synchronization */
   	$gCalObj = gCalSync_Init( $gUser, $gPass );

	/* Inserting the event into Google Calendar */
	gCalSync_Insert( $db_prefix, $boardurl, $gCalObj, 
		$title, $month, $day, $year, $span );
]]></add>
		</operation>

		<!-- For event editting and deletion -->
		<operation>
			<search position="before"><![CDATA[	global $modSettings, $topic, $ID_MEMBER, $func;]]></search>
			<add><![CDATA[
	global $boardurl;
	
	/* gCalSync: Bringing it in... */
	require_once( $sourcedir . '/gCalSync.php' );

	/* Grab a couple of useful values from $modSettings */
	if( !empty($modSettings['gCal_user']) &&
		!empty($modSettings['gCal_pass'] ) )
	{
		$gUser = $modSettings['gCal_user'];
		$gPass = $modSettings['gCal_pass'];
	}
	else
	{
		fatal_lang_error('gCalE7');
	}
]]></add>
		</operation>

		<!-- For event deletion -->
		<operation>
			<search position="before"><![CDATA[		elseif (isset($_REQUEST['deleteevent']))]]></search>
			<add><![CDATA[
		{
		/* Initializing the gCalSync for Google Calendar Synchronization */
		$gCalObj = gCalSync_Init( $gUser, $gPass );

		/* Deleting the event from Google Calendar */
		gCalSync_Remove( $db_prefix, $gCalObj, (int) $_REQUEST['eventid'] ); 
]]></add>
        </operation>

		<operation>
			<search position="after"><![CDATA[		// ... or just update it?]]></search>
			<add><![CDATA[
		}
			]]></add>
		</operation>

		<!-- For event update -->
		<operation>
			<search position="before"><![CDATA[			$start_time = mktime(0, 0, 0, (int) $_REQUEST['month'], (int) $_REQUEST['day'], (int) $_REQUEST['year']);]]></search>
			<add><![CDATA[
			/* Initializing the gCalSync for Google Calendar Synchronization */
			$gCalObj = gCalSync_Init( $gUser, $gPass );
			
			/* Update the event in Google Calendar */
			gCalSync_Update( $db_prefix, $gCalObj, (int) $_REQUEST['eventid'],
						(string) $_REQUEST['evtitle'], (int) $_REQUEST['month'],
						(int) $_REQUEST['day'], (int) $_REQUEST['year'], $span );
]]></add>
		</operation>
	</file>

	<file name="$sourcedir/Post.php">
		<!-- For event editting and deletion -->
		<operation>
			<search position="after"><![CDATA[	// Previewing? Go back to start.]]></search>
			<add><![CDATA[
	global $boardurl;
	
	/* gCalSync: Bringing it in... */
	require_once( $sourcedir . '/gCalSync.php' );
	
	/* Grab a couple of useful values from $modSettings */
	if( !empty($modSettings['gCal_user']) &&
		!empty($modSettings['gCal_pass'] ) )
	{
		$gUser = $modSettings['gCal_user'];
		$gPass = $modSettings['gCal_pass'];
	}
	else
	{
		fatal_lang_error('gCalE7');
	}
]]></add>
		</operation>
		
		<!-- For event deletion -->
		<operation>
			<search position="before"><![CDATA[		if (isset($_REQUEST['deleteevent']))]]></search>
			<add><![CDATA[
		{
		/* Initializing the gCalSync for Google Calendar Synchronization */
		$gCalObj = gCalSync_Init( $gUser, $gPass );

		/* Deleting the event from Google Calendar */
		gCalSync_Remove( $db_prefix, $gCalObj, (int) $_REQUEST['eventid'] ); 
]]></add>
        </operation>

		<operation>
			<search position="after"><![CDATA[		// ... or just update it?]]></search>
			<add><![CDATA[
		}
			]]></add>
		</operation>
	
		<!-- For event update -->
		<operation>
			<search position="before"><![CDATA[			$start_time = mktime(0, 0, 0, (int) $_REQUEST['month'], (int) $_REQUEST['day'], (int) $_REQUEST['year']);]]></search>
			<add><![CDATA[
			/* Initializing the gCalSync for Google Calendar Synchronization */
		        $gCalObj = gCalSync_Init( $gUser, $gPass );

			/* Update the event in Google Calendar */
			gCalSync_Update( $db_prefix, $gCalObj, (int) $_REQUEST['eventid'],
						(string) $_REQUEST['evtitle'], (int) $_REQUEST['month'],
						(int) $_REQUEST['day'], (int) $_REQUEST['year'], $span );
]]></add>
		</operation>
	</file>

	<file name="$sourcedir/RemoveTopic.php">
		<operation>
			<search position="before"><![CDATA[	global $db_prefix, $sourcedir, $modSettings;]]></search>
			<add><![CDATA[
	global $boardurl;

	/* gCalSync: Bringing it in... */
	require_once( $sourcedir . '/gCalSync.php' );

	/* Grab a couple of useful values from $modSettings */
	if( !empty($modSettings['gCal_user']) &&
		!empty($modSettings['gCal_pass'] ) )
	{
		$gUser = $modSettings['gCal_user'];
		$gPass = $modSettings['gCal_pass'];
	}
	
	else
	{
		fatal_lang_error('gCalE7');
	}
]]></add>
		</operation>
	
		<operation>
			<search position="before"><![CDATA[	// Delete anything related to the topic.]]></search>
			<add><![CDATA[
	$result = db_query( "SELECT ID_EVENT FROM {$db_prefix}calendar
			WHERE ID_TOPIC $condition", __FILE__, __LINE__ );
	
	while( $row = mysql_fetch_assoc( $result ) )
	{   
		$gCalEventID = $row[ 'ID_EVENT' ];
	}
	mysql_free_result( $result );

	/* Delete entry from Google Calendar only if a calendar entry exists */
	if( !empty( $gCalEventID ) )
	{
		/* Initializing the gCalSync for Google Calendar Synchronization */
		$gCalObj = gCalSync_Init( $gUser, $gPass );

		/* Deleting the event from Google Calendar */
		gCalSync_Remove( $db_prefix, $gCalObj, $gCalEventID );
	}
]]></add>
		</operation>
	</file>


</modification>
